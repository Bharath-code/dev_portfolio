---
import Layout from "@/layouts/Layout.astro";
import Hero from "@/components/ui/Hero.astro";
import ProjectCard from "@/components/ui/ProjectCard.astro";
import Experience from "@/components/ui/Experience.astro";
import Heading from "@/components/ui/Heading.astro";
import AiToolkit from "@/components/ui/AiToolkit.astro";
import ContactSection from "@/components/ui/ContactSection.astro";
import { ImpactMetrics } from "@/components/ui/ImpactMetrics";
import { siteContent } from "@/content/site-content";
import { fetchRepoStatsByUrls } from "@/lib/github";
import { ArrowUpRight } from "lucide-react";

// Fetch GitHub stats for curated projects at build time
const projectUrls = siteContent.projects.map((p) => p.link);
const repoStatsMap = await fetchRepoStatsByUrls(projectUrls);

// Helper to get stats for a project
function getStatsForProject(link: string) {
    const match = link.match(/github\.com\/[^/]+\/([^/]+)/);
    if (!match) return undefined;
    const repoName = match[1].replace(/\.git$/, "").toLowerCase();
    return repoStatsMap.get(repoName);
}
---

<Layout title="Bharath | Developer Tools & AI-Augmented Engineering">
    <Hero />

    <!-- ═══ WORK ═══ -->
    <section id="work" class="reveal px-4 py-24 md:px-8">
        <div class="mx-auto max-w-[1400px]">
            <div
                class="mb-12 flex flex-col md:flex-row md:items-end justify-between gap-6"
            >
                <div>
                    <Heading variant="section">Selected Work</Heading>
                    <p class="text-black/60 dark:text-white/50 max-w-xl mt-2">
                        Open-source tools and full-stack systems — each solving
                        a real developer pain point.
                    </p>
                </div>
                <a
                    href="https://github.com/Bharath-code"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group inline-flex items-center gap-2 text-sm font-medium text-black/40 dark:text-white/40 transition-colors hover:text-signal-emerald"
                >
                    View All on GitHub
                    <ArrowUpRight
                        className="w-4 h-4 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5"
                    />
                </a>
            </div>
            <div class="grid gap-6 md:grid-cols-2">
                {
                    siteContent.projects.map((project) => (
                        <div class="reveal">
                            <ProjectCard
                                {...project}
                                githubStats={getStatsForProject(project.link)}
                            />
                        </div>
                    ))
                }
            </div>
        </div>
    </section>

    <!-- ═══ AI EDGE ═══ -->
    <section
        class="reveal px-4 py-24 md:px-8 bg-black/[0.02] dark:bg-white/[0.02]"
    >
        <div class="mx-auto max-w-[1200px]">
            <AiToolkit {...siteContent.aiToolkit} />
        </div>
    </section>

    <!-- ═══ EXPERIENCE ═══ -->
    <section id="experience" class="reveal px-4 py-24 md:px-8">
        <div class="mx-auto max-w-[1000px]">
            <div class="mb-12 text-center">
                <Heading variant="section">Experience</Heading>
                <p class="text-black/50 dark:text-white/40 mt-2">
                    A timeline of shipping production software.
                </p>
            </div>
            <Experience items={siteContent.experience} />
        </div>
    </section>

    <!-- ═══ CONTACT ═══ -->
    <ContactSection />
</Layout>
