---
import Layout from "@/layouts/Layout.astro";
import Hero from "@/components/ui/Hero.astro";
import ProjectCard from "@/components/ui/ProjectCard.astro";
import Experience from "@/components/ui/Experience.astro";
import Heading from "@/components/ui/Heading.astro";
import Skills from "@/components/ui/Skills.astro";
import GitHubHeatmap from "@/components/ui/GitHubHeatmap.astro";
import LanguageChart from "@/components/ui/LanguageChart.astro";
import RepoShowcase from "@/components/ui/RepoShowcase.astro";
import TerminalAbout from "@/components/ui/TerminalAbout.astro";
import ContactSection from "@/components/ui/ContactSection.astro";
import { ImpactMetrics } from "@/components/ui/ImpactMetrics";
import { siteContent } from "@/content/site-content";
import { fetchRepoStatsByUrls } from "@/lib/github";
import { ArrowUpRight } from "lucide-react";

// Fetch GitHub stats for curated projects at build time
const projectUrls = siteContent.projects.map((p) => p.link);
const repoStatsMap = await fetchRepoStatsByUrls(projectUrls);

// Helper to get stats for a project
function getStatsForProject(link: string) {
    const match = link.match(/github\.com\/[^/]+\/([^/]+)/);
    if (!match) return undefined;
    const repoName = match[1].replace(/\.git$/, "").toLowerCase();
    return repoStatsMap.get(repoName);
}
---

<Layout title="Bharath | Senior Frontend Architect">
    <Hero />

    <section
        class="reveal px-4 py-24 md:px-8 border-b border-black/10 dark:border-white/10"
    >
        <div class="mx-auto max-w-[1000px] text-center">
            <Heading variant="section">Skills & Technologies</Heading>
            <div class="mt-6">
                <Skills items={siteContent.skills} />
            </div>
        </div>
    </section>

    <section
        class="reveal px-4 py-24 md:px-8 bg-black/5 dark:bg-surface-dark/50"
    >
        <div class="mx-auto max-w-[1400px]">
            <div class="mb-10">
                <Heading variant="section">Engineered Impact</Heading>
                <p class="max-w-xl text-lg text-gray-600 dark:text-gray-400">
                    Measurable results from systems I've architected and teams
                    I've led.
                </p>
            </div>
            <ImpactMetrics
                metrics={siteContent.impactHighlights}
                client:visible
            />
        </div>
    </section>

    <section id="work" class="reveal px-4 py-24 md:px-8">
        <div class="mx-auto max-w-[1400px]">
            <div
                class="mb-12 flex flex-col md:flex-row md:items-end justify-between gap-6"
            >
                <div>
                    <Heading variant="section">Selected Work</Heading>
                    <p class="text-gray-600 dark:text-gray-400 max-w-xl">
                        A curated selection of projects demonstrating
                        architectural thinking and technical execution.
                    </p>
                </div>
                <a
                    href="https://github.com/Bharath-code"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="group inline-flex items-center gap-2 text-sm font-medium text-gray-500 transition-colors hover:text-signal-emerald"
                >
                    View All Projects
                    <ArrowUpRight
                        className="w-4 h-4 transition-transform group-hover:translate-x-0.5 group-hover:-translate-y-0.5"
                    />
                </a>
            </div>
            <div class="grid gap-6 md:grid-cols-2">
                {
                    siteContent.projects.map((project) => (
                        <div class="reveal">
                            <ProjectCard
                                {...project}
                                githubStats={getStatsForProject(project.link)}
                            />
                        </div>
                    ))
                }
            </div>
        </div>
    </section>

    <section
        id="experience"
        class="reveal px-4 py-24 md:px-8 bg-surface-dark/30"
    >
        <div class="mx-auto max-w-[1000px]">
            <div class="mb-12 text-center">
                <Heading variant="section">Experience</Heading>
                <p class="text-gray-400">
                    A timeline of technical leadership and delivery.
                </p>
            </div>
            <Experience items={siteContent.experience} />
        </div>
    </section>

    <!-- GitHub Activity Section -->
    <GitHubHeatmap />
    <LanguageChart />
    <RepoShowcase />

    <!-- Terminal About -->
    <TerminalAbout />

    <!-- Enhanced Contact Section -->
    <ContactSection />
</Layout>
