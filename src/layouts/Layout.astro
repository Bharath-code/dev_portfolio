---
interface Props {
    title: string;
    description?: string;
    ogImage?: string;
}

const {
    title,
    description = "Senior Frontend Architect & AI Engineer Portfolio",
    ogImage = "/og-image.png",
} = Astro.props;

import { siteContent } from "@/content/site-content";
const keywords = siteContent.skills.join(", ");
import "@/styles/global.css";
import NavBar from "@/components/ui/NavBar.astro";
import Footer from "@/components/ui/Footer.astro";
import CustomCursor from "@/components/ui/CustomCursor.astro";
import Preloader from "@/components/ui/Preloader.astro";
import RecruiterPanel from "@/components/ui/RecruiterPanel.astro";
import CurrentlyBuilding from "@/components/ui/CurrentlyBuilding.astro";
import ThemeCustomizer from "@/components/ui/ThemeCustomizer.astro";
import { ClientRouter } from "astro:transitions";
import "@fontsource/archivo-black";
import "@fontsource/manrope";
import "@fontsource/manrope/500.css";
import "@fontsource/manrope/600.css";
import "@fontsource/manrope/800.css";
---

<!doctype html>
<html
    lang="en"
    class="scroll-smooth bg-white text-black dark:bg-void-black dark:text-white antialiased overflow-x-hidden"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content={description} />
        <script is:inline>
            // Initialize theme to prevent FOUC
            (() => {
                const getTheme = () => {
                    if (
                        typeof localStorage !== "undefined" &&
                        localStorage.getItem("theme")
                    ) {
                        return localStorage.getItem("theme");
                    }
                    if (
                        window.matchMedia("(prefers-color-scheme: dark)")
                            .matches
                    ) {
                        return "dark";
                    }
                    return "light";
                };

                if (getTheme() === "dark") {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }

                // Initialize accent color to prevent FOUC
                const savedAccent = localStorage.getItem("accent-color");
                if (savedAccent) {
                    document.documentElement.classList.add(savedAccent);
                }
            })();
        </script>
        <meta name="viewport" content="width=device-width" />
        <meta name="keywords" content={keywords} />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.site} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={new URL(ogImage, Astro.url)} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.site} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={new URL(ogImage, Astro.url)} />

        <link rel="canonical" href={Astro.url} />

        <!-- AEO: Advanced JSON-LD @graph for Entity Recognition & Relationship Mapping -->
        <script type="application/ld+json" is:inline>
            {
                "@context": "https://schema.org",
                "@graph": [
                    {
                        "@type": "Person",
                        "@id": "https://www.bharathkumar.dev/#person",
                        "name": "Bharathkumar Palanisamy",
                        "url": "https://www.bharathkumar.dev",
                        "image": "https://github.com/Bharath-code.png",
                        "sameAs": [
                            "https://github.com/Bharath-code",
                            "https://x.com/iam_pbk",
                            "https://linkedin.com/in/bharathkumar-palanisamy"
                        ],
                        "jobTitle": "Senior Software Architect",
                        "description": "Senior Frontend Architect & AI Engineer specializing in high-performance web systems and AI integration.",
                        "knowsAbout": [
                            "Frontend Architecture",
                            "React",
                            "TypeScript",
                            "Node.js",
                            "AI/ML",
                            "TUI Development",
                            "Go",
                            "Rust"
                        ]
                    },
                    {
                        "@type": "WebSite",
                        "@id": "https://www.bharathkumar.dev/#website",
                        "url": "https://www.bharathkumar.dev",
                        "name": "Bharath's Portfolio",
                        "publisher": {
                            "@id": "https://www.bharathkumar.dev/#person"
                        },
                        "inLanguage": "en-US"
                    },
                    {
                        "@type": "ProfessionalService",
                        "name": "Bharathkumar Palanisamy - Technical Consulting",
                        "image": "https://github.com/Bharath-code.png",
                        "@id": "https://www.bharathkumar.dev/#service",
                        "url": "https://www.bharathkumar.dev",
                        "telephone": "",
                        "address": {
                            "@type": "PostalAddress",
                            "addressLocality": "India",
                            "addressCountry": "IN"
                        },
                        "founder": {
                            "@id": "https://www.bharathkumar.dev/#person"
                        }
                    }
                ]
            }
        </script>

        <title>{title}</title>
        <ClientRouter />
    </head>
    <body
        class="selection:bg-signal-emerald selection:text-void-black relative"
    >
        <Preloader />
        <CustomCursor />
        <!-- Noise Texture Overlay -->
        <div class="grain-overlay"></div>

        <NavBar />
        <main class="relative z-10">
            <slot />
        </main>
        <RecruiterPanel />
        <CurrentlyBuilding />
        <ThemeCustomizer />
        <Footer />
        <style is:global>
            /* Smooth background transitions */
            body {
                transition: background-color 0.5s ease;
            }

            .grain-overlay {
                position: fixed;
                inset: 0;
                z-index: 9999;
                pointer-events: none;
                opacity: 0.035;
                mix-blend-mode: overlay;
                background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            }

            .dark .grain-overlay {
                opacity: 0.05;
            }

            .reveal {
                opacity: 0;
                transform: translateY(20px);
                transition:
                    opacity 0.8s cubic-bezier(0.22, 1, 0.36, 1),
                    transform 0.8s cubic-bezier(0.22, 1, 0.36, 1);
            }
            .reveal.active {
                opacity: 1;
                transform: translateY(0);
            }

            /* View Transition Animations */
            @keyframes fadeSlideIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeSlideOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }

            ::view-transition-old(root) {
                animation: fadeSlideOut 0.3s cubic-bezier(0.22, 1, 0.36, 1);
            }

            ::view-transition-new(root) {
                animation: fadeSlideIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            }

            /* Disable transitions for reduced motion */
            @media (prefers-reduced-motion: reduce) {
                ::view-transition-old(root),
                ::view-transition-new(root) {
                    animation: none;
                }
            }
        </style>

        <script>
            import { gsap } from "gsap";
            import { ScrollTrigger } from "gsap/ScrollTrigger";

            gsap.registerPlugin(ScrollTrigger);

            function setupMagneticButtons() {
                const magneticElements =
                    document.querySelectorAll("[data-magnetic]");

                magneticElements.forEach((el: any) => {
                    el.addEventListener("mousemove", (e: any) => {
                        // Performance/UX: Only apply magnetic effect for non-touch pointers
                        if (e.pointerType === "touch") return;

                        const rect = el.getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width / 2;
                        const y = e.clientY - rect.top - rect.height / 2;

                        gsap.to(el, {
                            x: x * 0.35,
                            y: y * 0.35,
                            scale: 1.05,
                            duration: 0.6,
                            ease: "power3.out",
                        });
                    });

                    el.addEventListener("mouseleave", (e: any) => {
                        if (e.pointerType === "touch") return;

                        gsap.to(el, {
                            x: 0,
                            y: 0,
                            scale: 1,
                            duration: 0.8,
                            ease: "elastic.out(1, 0.4)",
                        });
                    });
                });
            }

            function initScrollAnimations() {
                // Scroll Reveal
                const observerOptions = {
                    root: null,
                    rootMargin: "0px",
                    threshold: 0.1,
                };

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add("active");
                        }
                    });
                }, observerOptions);

                const revealElements = document.querySelectorAll(".reveal");
                revealElements.forEach((el) => observer.observe(el));

                // Parallax Headings
                const parallaxHeadings =
                    document.querySelectorAll("[data-parallax]");
                parallaxHeadings.forEach((el) => {
                    const speed = el.getAttribute("data-parallax") || "0.1";
                    gsap.to(el, {
                        y: 50 * parseFloat(speed),
                        ease: "none",
                        scrollTrigger: {
                            trigger: el,
                            start: "top bottom",
                            end: "bottom top",
                            scrub: true,
                        },
                    });
                });
            }

            // Run on initial load
            initScrollAnimations();
            setupMagneticButtons();

            // Run on view transition navigation
            document.addEventListener("astro:page-load", () => {
                initScrollAnimations();
                setupMagneticButtons();
            });
        </script>
    </body>
</html>
